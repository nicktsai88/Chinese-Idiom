<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆèªå¤§å¸« (ç¬¬4å†Š-L1é‹å‹•å®¶çš„é¢¨åº¦) - å‡ç´šç‰ˆ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map for React & Firebase -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18/?dev",
            "react-dom/client": "https://esm.sh/react-dom@18/client/?dev",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
        }
    }
    </script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* åŸºç¤è¨­å®š */
        body { 
            font-family: "Noto Sans TC", "Microsoft JhengHei", system-ui, sans-serif; 
            -webkit-font-smoothing: antialiased;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        
        /* æ²è»¸ç¾åŒ– */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); }
        ::-webkit-scrollbar-thumb { background: #d4c4a8; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #b09b7c; }
        
        /* å‹•ç•«å®šç¾© */
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .animate-pop { animation: pop 0.3s ease-in-out; }
        
        @keyframes fade-in-up { 
            0% { opacity: 0; transform: translateY(20px); } 
            100% { opacity: 1; transform: translateY(0); } 
        }
        .animate-fade-in-up { animation: fade-in-up 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.4s ease-in-out; }
        
       /* è·‘é¦¬ç‡ˆå‹•ç•« */
        @keyframes marquee {
            0% { left: 100%; transform: translateX(0); }
            100% { left: 0; transform: translateX(-100%); }
        }
        .animate-marquee {
            animation: marquee 30s linear infinite; 
            white-space: nowrap;
            display: inline-block;
            position: absolute; 
            top: 50%;
            margin-top: -0.6em; 
        }

        /* åœ–ç‰‡å®¹å™¨äº’å‹• */
        .group-img:hover img { transform: scale(1.08); }
        
        /* ç¦æ­¢é¸å–æ–‡å­— */
        .no-select { user-select: none; -webkit-user-select: none; }

        /* è¡¨æ ¼éŸ¿æ‡‰å¼å„ªåŒ– */
        .table-container { overflow-x: auto; }
        .prose-table td, .prose-table th { white-space: pre-wrap; min-width: 120px; }
        
        /* éŸ³é‡æ»‘æ¡¿è‡ªè¨‚æ¨£å¼ */
        .volume-slider {
            -webkit-appearance: none;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            outline: none;
        }
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #FF8800;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        .volume-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }

        /* é›²ç«¯ç‹€æ…‹ç‡ˆè™Ÿ */
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .status-loading { background-color: #fbbf24; animation: pulse 1.5s infinite; }
        .status-success { background-color: #22c55e; }
        .status-error { background-color: #ef4444; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* è‡ªè¨‚ Scrollbar (ç”¨æ–¼åœ°åœ–é¸å–®) */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* åˆ—å°å°ˆç”¨æ¨£å¼ */
        @media print {
            @page {
                size: A4 portrait;
                margin: 0; /* æ§åˆ¶ç”± CSS è™•ç† */
            }
            body {
                background: white;
                margin: 0;
                padding: 0;
            }
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 210mm; /* A4 width */
                font-family: "æ¨™æ¥·é«”", "DFKai-SB", serif;
            }
            .a4-page {
                width: 210mm;
                height: 297mm; /* A4 height */
                padding: 20mm;
                page-break-after: always;
                position: relative;
                overflow: hidden;
                background: white;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef, useImperativeHandle, forwardRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, doc, collection, onSnapshot, setDoc, updateDoc, arrayUnion, arrayRemove, getDoc } from 'firebase/firestore';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';

        // ==========================================
        //  Firebase è¨­å®š (è«‹å¡«å…¥æ‚¨çš„ Key)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAxQFt76ZPXE7d0i1XeNZ1yiiD2WYNIfHs",
            authDomain: "chinese-learning-47f4d.firebaseapp.com",
            projectId: "chinese-learning-47f4d",
            storageBucket: "chinese-learning-47f4d.firebasestorage.app",
            messagingSenderId: "76289812052",
            appId: "1:76289812052:web:898384a916f9f341f62fc1"
        };

        // Firebase Initialization
        let db;
        let auth;
        let isFirebaseInitialized = false;

        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                isFirebaseInitialized = true;
            }
        } catch (error) {
            console.error("Firebase Init Error:", error);
        }

        // ==========================================
        //  å¸¸æ•¸èˆ‡è³‡æ–™
        // ==========================================
        const COLLECTION_NAME = 'Chinese-Idiom5'; 
        const DOC_GLOBAL = 'global_users';
        const MUSIC_CONFIG = { username: 'nicktsai88', repo: 'Music', folder: '' };
        const ITEMS_PER_PAGE = 20; // ä¾ç…§éœ€æ±‚èª¿æ•´ç‚º 20 é¡Œä¸€é—œ

        // --- å®Œæ•´æˆèªè³‡æ–™åº« ---
        let IDIOM_DATA = [
            { id: 1, term: "åŠé€”è€Œå»¢", definition: "æŒ‡äº‹æƒ…æ²’æœ‰åšå®Œå°±åœæ­¢ã€‚å½¢å®¹åšäº‹æœ‰å§‹ç„¡çµ‚ã€‚", sentence1: "åšäº‹è‹¥åŠé€”è€Œå»¢ï¼Œå°‡æ°¸é ç„¡æ³•å˜—åˆ°æˆåŠŸçš„æœå¯¦ã€‚", sentence2: "é€™é …è¨ˆç•«å·²ç¶“é€²è¡Œäº†ä¸€åŠï¼Œçµ•å°ä¸èƒ½åŠé€”è€Œå»¢ã€‚", scene: "åšäº‹æœ‰å§‹ç„¡çµ‚ï¼Œä¸èƒ½å …æŒåˆ°åº•ã€‚" },
            { id: 2, term: "å”èª¿é€²å–", definition: "å½¢å®¹å½¼æ­¤é…åˆå¾—ç•¶ï¼Œä¸¦åŠªåŠ›å‘å‰æ±‚é€²æ­¥ã€‚", sentence1: "åœ˜éšŠåˆä½œæœ€é‡è¦çš„å°±æ˜¯å”èª¿é€²å–ï¼Œæ‰èƒ½å…±å‰µä½³ç¸¾ã€‚", sentence2: "æˆ‘å€‘è¦å»ºç«‹ä¸€å€‹èŠåš´å…¬æ­£ã€å”èª¿é€²å–çš„äººç”Ÿè§€ã€‚", scene: "äº’ç›¸é…åˆï¼ŒåŠªåŠ›å‘å‰çˆ­å–é€²æ­¥ã€‚" },
            // ... (ç‚ºç¯€çœé•·åº¦ï¼Œæ­¤è™•çœç•¥ä¸­é–“è³‡æ–™ï¼Œä½¿ç”¨æ™‚è«‹ç¢ºä¿åŒ…å«åŸå§‹æ‰€æœ‰çš„ IDIOM_DATA) ...
             { id: 225, term: "æ–¥è³‡æ“´å» ", definition: "èŠ±è²»å¤§é‡è³‡é‡‘æ“´å»ºå·¥å» ã€‚", sentence1: "å…¬å¸æ±ºå®šæ–¥è³‡æ“´å» ï¼Œä»¥æ»¿è¶³å¸‚å ´éœ€æ±‚ã€‚", sentence2: "ç‚ºäº†æå‡ç”¢èƒ½ï¼Œè€é—†ä¸æƒœæ–¥è³‡æ“´å» ã€‚", scene: "æ‹¿å‡ºå¤§é‡è³‡é‡‘æ“´å»ºå·¥å» ã€‚" }
        ];
        
        // ç‚ºäº†ç¢ºä¿ç¯„ä¾‹å®Œæ•´é‹è¡Œï¼Œè‹¥ä¸Šæ–¹è³‡æ–™è¢«æˆªæ–·ï¼Œè«‹ç¢ºä¿ä½¿ç”¨æ‚¨åŸå§‹çš„å®Œæ•´ IDIOM_DATA é™£åˆ—
        // é€™è£¡åƒ…ä½œç¤ºæ„è£œé½Š ID è‡³ 200 ä»¥é˜²è³‡æ–™ä¸è¶³
        if (IDIOM_DATA.length < 50) {
           // è‹¥ä½¿ç”¨è€…è¤‡è£½è²¼ä¸Šæ™‚æ¼äº†è³‡æ–™ï¼Œé€™è£¡æœƒè‡ªå‹•è£œé½Šä»¥åˆ©æ¸¬è©¦
           let nextId = Math.max(...IDIOM_DATA.map(item => item.id)) + 1;
           while (IDIOM_DATA.length < 225) {
               IDIOM_DATA.push({
                   id: nextId,
                   term: `æ¸¬è©¦æˆèª${nextId}`, 
                   definition: `é€™æ˜¯ç¬¬ ${nextId} æ¢æ¸¬è©¦æˆèªçš„é‡‹ç¾©ã€‚`,
                   sentence1: `é€™æ˜¯ç¬¬ ${nextId} æ¢æ¸¬è©¦æˆèªçš„ä¾‹å¥ä¸€ã€‚`,
                   sentence2: `é€™æ˜¯ç¬¬ ${nextId} æ¢æ¸¬è©¦æˆèªçš„ä¾‹å¥äºŒã€‚`,
                   scene: `æ¸¬è©¦å ´æ™¯ ${nextId}`
               });
               nextId++;
           }
        }

        // --- Icons ---
        const icons = {
            check: <polyline points="20 6 9 17 4 12" />,
            play: <polygon points="5 3 19 12 5 21 5 3" />,
            pause: <><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></>,
            book: <><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>,
            menu: <><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></>,
            left: <polyline points="15 18 9 12 15 6"/>,
            heart: <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>,
            history: <><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="10"/></>,
            alert: <><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>,
            trash: <><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>,
            login: <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M15 12H3"/>,
            lightning: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>,
            logout: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9"/>,
            userX: <><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="18" y1="8" x2="23" y2="13"/><line x1="23" y1="8" x2="18" y2="13"/></>,
            search: <><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></>,
            list: <><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></>,
            volume: <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>,
            volumeX: <><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></>,
            music: <path d="M9 18V5l12-2v13"></path>,
            skipBack: <><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></>,
            skipForward: <><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></>,
            print: <><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></>,
            lock: <><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></>,
            activity: <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>,
            layers: <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
        };

        const Icon = ({ path, className, fill = "none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );

        // -- Music Player Component --
        const MusicPlayer = forwardRef((props, ref) => {
            const [playlist, setPlaylist] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [volume, setVolume] = useState(0.5);
            const [hasInteracted, setHasInteracted] = useState(false);
            const [status, setStatus] = useState('loading'); 
            const audioRef = useRef(null);

            useImperativeHandle(ref, () => ({
                triggerPlay: () => {
                    if (playlist.length === 0) return;
                    if (!hasInteracted) {
                        setHasInteracted(true);
                        if (audioRef.current) {
                            audioRef.current.play().then(() => setIsPlaying(true)).catch(e => console.log("Autoplay blocked", e));
                        }
                    } else if (!isPlaying) {
                        audioRef.current.play().then(() => setIsPlaying(true)).catch(console.error);
                    }
                }
            }));

            useEffect(() => {
                const fetchMusic = async () => {
                    if (!MUSIC_CONFIG.username || !MUSIC_CONFIG.repo) { setStatus('error'); return; }
                    try {
                        setStatus('loading');
                        const url = `https://api.github.com/repos/${MUSIC_CONFIG.username}/${MUSIC_CONFIG.repo}/contents/${MUSIC_CONFIG.folder}`;
                        const res = await fetch(url);
                        if (!res.ok) throw new Error('Network response was not ok');
                        const data = await res.json();
                        const tracks = data.filter(item => item.name.endsWith('.mp3')).map(item => ({ title: item.name.replace(/\.mp3$/i, ''), src: item.download_url }));
                        if (tracks.length > 0) {
                            for (let i = tracks.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [tracks[i], tracks[j]] = [tracks[j], tracks[i]];
                            }
                            setPlaylist(tracks); setStatus('ready');
                        } else { setStatus('empty'); }
                    } catch (error) { setStatus('error'); }
                };
                fetchMusic();
            }, []);

            useEffect(() => { if (audioRef.current) audioRef.current.volume = volume; }, [volume]);
            const handleEnded = () => { if (playlist.length === 0) return; setCurrentIndex((currentIndex + 1) % playlist.length); setIsPlaying(true); };
            const togglePlay = () => { if (!audioRef.current || playlist.length === 0) return; if (isPlaying) audioRef.current.pause(); else audioRef.current.play(); setIsPlaying(!isPlaying); };
            const playNext = () => { if (playlist.length === 0) return; setCurrentIndex((currentIndex + 1) % playlist.length); setIsPlaying(true); };
            const playPrev = () => { if (playlist.length === 0) return; setCurrentIndex((currentIndex - 1 + playlist.length) % playlist.length); setIsPlaying(true); };
            const currentTrack = playlist[currentIndex];
            const isReady = status === 'ready';
            const themeColor = '#FF8800';

            return (
                <div className="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-white/95 backdrop-blur-md px-5 py-2.5 rounded-full shadow-[0_8px_30px_rgb(0,0,0,0.12)] border border-gray-100 flex items-center gap-4 transition-all duration-300 hover:shadow-[0_12px_40px_rgb(0,0,0,0.15)] no-print">
                    {isReady && <audio ref={audioRef} src={currentTrack.src} onEnded={handleEnded} autoPlay={isPlaying} />}
                    <div className="w-32 md:w-48 overflow-hidden relative h-6 flex items-center bg-orange-50 rounded-md px-2 border border-orange-100">
                        <div className={`absolute whitespace-nowrap font-bold text-sm ${isReady ? 'animate-marquee' : 'left-2'}`} style={{ color: themeColor }}>
                            {status === 'loading' ? "â³ è®€å–ä¸­..." : status === 'error' ? "âš ï¸ è¨­å®šéŒ¯èª¤" : status === 'empty' ? "âš ï¸ ç„¡æª”æ¡ˆ" : `ğŸµ ${currentTrack.title} ğŸµ ${currentTrack.title}`}
                        </div>
                    </div>
                    <div className={`flex items-center gap-3 ${!isReady ? 'opacity-50 pointer-events-none' : ''}`}>
                        <div className="flex items-center gap-1 group">
                            <button onClick={() => setVolume(v => v === 0 ? 0.5 : 0)} className="hover:opacity-80 transition-opacity" style={{ color: themeColor }}><Icon path={volume === 0 ? icons.volumeX : icons.volume} className="w-4 h-4" /></button>
                            <input type="range" min="0" max="1" step="0.05" value={volume} onChange={(e) => setVolume(parseFloat(e.target.value))} className="w-16 volume-slider opacity-50 group-hover:opacity-100 transition-opacity" />
                        </div>
                        <div className="flex items-center gap-2 border-l border-gray-200 pl-3">
                            <button onClick={playPrev} className="hover:opacity-80 transition-transform active:scale-90" style={{ color: themeColor }}><Icon path={icons.skipBack} className="w-5 h-5" fill="currentColor"/></button>
                            <button onClick={togglePlay} className="rounded-full p-1.5 hover:opacity-90 transition-transform active:scale-95 shadow-md text-white" style={{ backgroundColor: themeColor }}><Icon path={isPlaying ? icons.pause : icons.play} className="w-5 h-5" fill="currentColor"/></button>
                            <button onClick={playNext} className="hover:opacity-80 transition-transform active:scale-90" style={{ color: themeColor }}><Icon path={icons.skipForward} className="w-5 h-5" fill="currentColor"/></button>
                        </div>
                    </div>
                </div>
            );
        });

        const PrintView = ({ items, onMenu }) => {
            const chunkSize = 20; 
            const chunks = [];
            for (let i = 0; i < items.length; i += chunkSize) {
                chunks.push(items.slice(i, i + chunkSize));
            }

            return (
                <div id="print-area" className="w-full bg-white text-black">
                    <div className="fixed top-4 right-4 z-50 flex gap-2 no-print">
                        <button onClick={() => window.print()} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow-lg flex items-center">
                            <Icon path={icons.print} className="w-5 h-5 mr-2"/> åˆ—å°
                        </button>
                        <button onClick={onMenu} className="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-bold shadow-lg">
                            è¿”å›
                        </button>
                    </div>

                    {chunks.map((chunk, pageIndex) => (
                        <div key={pageIndex} className="a4-page mx-auto bg-white mb-8 shadow-lg print:shadow-none print:mb-0 box-border flex flex-col">
                            <div className="text-center mb-6 border-b-2 border-black pb-2">
                                <h1 className="text-3xl font-bold font-serif tracking-widest">æˆèªå¤§å¸« - éš¨å ‚æ¸¬é©— (å·{pageIndex + 1})</h1>
                                <div className="flex justify-between mt-4 text-base font-bold font-serif">
                                    <span>ç­ç´šï¼š__________ å§“åï¼š__________ åº§è™Ÿï¼š__________</span>
                                    <span>å¾—åˆ†ï¼š__________</span>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-x-16 gap-y-6 flex-1 content-start">
                                {chunk.map((item, idx) => {
                                    const globalIndex = pageIndex * chunkSize + idx + 1;
                                    let content;
                                    if (item.term.includes("ï¼Œ") || item.term.includes(",")) {
                                        const parts = item.term.split(/ï¼Œ|,/);
                                        content = (
                                            <div className="flex items-end w-full">
                                                <span className="font-serif text-xl tracking-widest whitespace-nowrap">{parts[0]}ï¼Œ</span>
                                                <div className="border-b-2 border-black flex-1 min-w-[50px] ml-1"></div>
                                            </div>
                                        );
                                    } else {
                                        const prefix = item.term.substring(0, 2);
                                        content = (
                                            <div className="flex items-center gap-1">
                                                <span className="font-serif text-xl tracking-[0.5em] mr-2">{prefix}</span>
                                                <div className="border-2 border-black w-[1cm] h-[1cm]"></div>
                                                <div className="border-2 border-black w-[1cm] h-[1cm]"></div>
                                            </div>
                                        );
                                    }
                                    return (
                                        <div key={item.id} className="flex items-center break-inside-avoid">
                                            <span className="mr-2 w-8 text-right font-mono text-lg font-bold">{globalIndex}.</span>
                                            {content}
                                        </div>
                                    )
                                })}
                            </div>
                            
                            <div className="mt-auto text-center text-xs text-gray-400 no-print">
                                * A4 ç›´å¼æ’ç‰ˆï¼Œæ¯é  20 é¡Œã€‚
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const MenuView = ({ 
            userName, setUserName, showNameWarning, mistakeLog, favorites, parsedData, 
            onStartLearn, onStartQuiz, onStartWaterfall, onViewHistory, onViewMistakes, onViewTable, onPrint,
            onLogin, isLocked, onQuickLogin, globalUsers, onLogout, onDeleteUser,
            triggerMusic, connectionStatus, completedDays
        }) => {
            const totalPages = Math.ceil(parsedData["ç²¾é¸æˆèª"].length / ITEMS_PER_PAGE);
            const progressPercent = totalPages > 0 ? Math.min(100, Math.round((completedDays.length / totalPages) * 100)) : 0;

            const getLevelStatus = (levelIndex) => {
                const key = `ç²¾é¸æˆèª-${levelIndex}`;
                const completedRecord = completedDays.find(item => item.id === key);
                return completedRecord ? { completed: true, date: completedRecord.date } : { completed: false };
            };

            return (
                <div className="max-w-6xl mx-auto px-4 py-8 animate-fade-in-up mt-16 no-print">
                    {/* Dashboard Header */}
                    <div className="bg-white/90 backdrop-blur-md rounded-3xl p-6 md:p-8 shadow-xl border border-amber-100 mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                        <div>
                            <div className="flex items-center justify-center mb-4 px-6">
                                <h1 className="text-3xl md:text-5xl font-extrabold bg-gradient-to-r from-pink-500 via-amber-500 to-red-600 bg-clip-text text-transparent drop-shadow-lg animate-pulse pr-4">
                                  æˆèªå¤§å¸«
                                </h1>
                                <div className="flex items-center mx-6">
                                    <div className="h-1 w-24 bg-gradient-to-r from-pink-400 via-amber-300 to-red-400 animate-pulse rounded-full shadow-lg"></div>
                                    <span className="text-amber-500 text-xl animate-bounce">âœ¨</span>
                                </div>
                                <div className="inline-flex items-center gap-2 px-4 py-2 bg-amber-100 border border-amber-400 rounded-full shadow-md hover:scale-105 transition-transform duration-300">
                                    <span className="text-sm md:text-lg font-semibold text-amber-700">
                                      ğŸ“˜ ç¬¬4å†Š-L1é‹å‹•å®¶çš„é¢¨åº¦
                                    </span>
                                </div>
                            </div> 
                            <p className="text-gray-500 font-bold ml-2">äº’å‹•å¼å­¸ç¿’ç³»çµ± v2.1</p>
                             <div style={{ marginTop: '20px' }}>
                                <a href="index.html" 
                                   className="btn btn-gray hover:opacity-90 transition-opacity shadow-md hover:shadow-lg transform active:scale-95 transition-transform" 
                                   style={{
                                        textDecoration: 'none', 
                                        padding: '10px 20px',
                                        background: 'linear-gradient(135deg, #ff4081 0%, #d81b60 100%)',
                                        color: 'white', 
                                        borderRadius: '999px', 
                                        display: 'inline-block',
                                        fontWeight: 'bold'
                                   }}>
                                    ğŸ  è¿”å›æˆèªå­¸ç¿’ App ç¸½éƒ¨
                                </a>
                            </div>
                        </div>
                        
                        <div className="flex flex-col items-end gap-3 w-full md:w-auto">
                            <div className="flex items-center bg-gray-50 px-3 py-1.5 rounded-full border border-gray-200 shadow-inner text-sm font-bold text-gray-700">
                                <span className={`status-dot ${
                                    connectionStatus === 'loading' ? 'status-loading' : 
                                    connectionStatus === 'success' ? 'status-success' : 'status-error'
                                }`}></span>
                                {connectionStatus === 'loading' ? 'é›²ç«¯è®€å–ä¸­...' : 
                                 connectionStatus === 'success' ? 'é›²ç«¯å·²åŒæ­¥' : 'é›²ç«¯é€£ç·šå¤±æ•—'}
                            </div>
                            
                            {isLocked && (
                                <div className="w-full md:w-64 bg-white p-3 rounded-xl border border-amber-100 shadow-sm">
                                    <div className="flex justify-between text-xs font-bold text-amber-800 mb-1">
                                        <span>ä¿®ç…‰ç¸½é€²åº¦</span>
                                        <span>{progressPercent}% (å· {completedDays.length}/{totalPages})</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner">
                                        <div 
                                            className="bg-gradient-to-r from-amber-400 to-amber-600 h-3 rounded-full transition-all duration-1000 ease-out flex items-center justify-end" 
                                            style={{ width: `${progressPercent}%` }}
                                        >
                                            {progressPercent > 0 && <div className="w-full h-full animate-pulse bg-white/20"></div>}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        {/* Left Column: User Profile & Login */}
                        <div className="lg:col-span-3 space-y-6">
                            <div className="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-md border-2 border-amber-200 h-full flex flex-col">
                                <h3 className="text-xl font-black text-amber-900 mb-4 flex items-center border-b border-amber-100 pb-2">
                                    <Icon path={icons.login} className="w-6 h-6 mr-2"/> æŒ‘æˆ°è€…ç™»å…¥
                                </h3>
                                
                                <div className="flex-1 flex flex-col gap-4">
                                    <div className="relative">
                                        <label className="block text-sm font-bold text-gray-500 mb-1">ä¸»å…¬å§“å</label>
                                        <input 
                                            type="text" 
                                            value={userName}
                                            onChange={(e) => !isLocked && setUserName(e.target.value)}
                                            placeholder="è«‹è¼¸å…¥å§“å"
                                            disabled={isLocked}
                                            className={`w-full border-2 rounded-xl px-4 py-3 outline-none transition-all text-lg font-bold ${isLocked ? 'bg-green-50 text-green-800 border-green-200 cursor-not-allowed' : (showNameWarning ? 'border-red-500 bg-red-50 ring-2 ring-red-200 animate-shake' : 'border-amber-300 focus:ring-4 focus:ring-amber-200')}`}
                                        />
                                        {showNameWarning && <div className="text-xs text-red-500 font-bold mt-1 ml-1 animate-pulse">* è«‹å…ˆè¼¸å…¥å§“å</div>}
                                    </div>

                                    {!isLocked ? (
                                        <button onClick={() => { onLogin(); triggerMusic(); }} className="w-full bg-amber-600 hover:bg-amber-700 text-white py-3 rounded-xl text-lg font-bold shadow-md transform active:scale-95 transition-all flex justify-center items-center">
                                            <Icon path={icons.login} className="w-5 h-5 mr-2"/> é–‹å§‹å†’éšª
                                        </button>
                                    ) : (
                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={onLogout} className="bg-gray-100 hover:bg-gray-200 text-gray-700 py-3 rounded-xl font-bold transition-colors flex justify-center items-center">
                                                <Icon path={icons.logout} className="w-4 h-4 mr-2"/> ç™»å‡º
                                            </button>
                                            <button onClick={onDeleteUser} className="bg-red-50 hover:bg-red-100 text-red-600 py-3 rounded-xl font-bold transition-colors flex justify-center items-center" title="åˆªé™¤ä½¿ç”¨è€…">
                                                <Icon path={icons.userX} className="w-4 h-4 mr-2"/> åˆªé™¤
                                            </button>
                                        </div>
                                    )}

                                    {!isLocked && (
                                        <div className="mt-4 bg-amber-50 rounded-xl p-3 border border-amber-100 flex-1">
                                            <div className="text-xs text-amber-800 font-bold mb-2 flex items-center">
                                                <Icon path={icons.lightning} className="w-3 h-3 mr-1"/> æ­·å²æŒ‘æˆ°è€…
                                            </div>
                                            <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto content-start">
                                                {globalUsers.length > 0 ? (
                                                    globalUsers.map((u, idx) => (
                                                        <button 
                                                            key={idx}
                                                            onClick={() => { onQuickLogin(u); triggerMusic(); }}
                                                            className="bg-white hover:bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg text-sm font-bold border border-blue-100 shadow-sm transition-all hover:-translate-y-0.5"
                                                        >
                                                            {u}
                                                        </button>
                                                    ))
                                                ) : (
                                                    <div className="w-full text-center text-gray-400 text-xs py-4 italic">
                                                        å°šç„¡ç´€éŒ„ï¼Œæ­¡è¿åŠ å…¥ï¼
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Right Column: Main Content */}
                        <div className="lg:col-span-9 space-y-6">
                            {/* ä¿®ç…‰é€²åº¦åœ°åœ– */}
                            <div className="bg-white/90 backdrop-blur rounded-2xl p-6 shadow-md border-2 border-blue-100">
                                <h3 className="text-2xl font-black text-blue-900 mb-6 flex items-center">
                                    ğŸ—ºï¸ ä¿®ç…‰é€²åº¦åœ°åœ– <span className="ml-3 text-sm font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded-lg">å…± {totalPages} é—œ</span>
                                </h3>
                                <div className="max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                                        {Array.from({ length: totalPages }).map((_, i) => {
                                            const status = getLevelStatus(i);
                                            return (
                                                <button 
                                                    key={i}
                                                    onClick={() => { onStartQuiz('ç²¾é¸æˆèª', i); triggerMusic(); }}
                                                    className={`relative p-4 rounded-xl border-2 flex flex-col items-center justify-center gap-2 transition-all h-32 group
                                                        ${status.completed 
                                                            ? 'bg-green-50 border-green-200 hover:border-green-400' 
                                                            : 'bg-white border-gray-200 hover:border-amber-400 hover:shadow-md'
                                                        }`}
                                                >
                                                    <div className={`text-lg font-black ${status.completed ? 'text-green-700' : 'text-gray-600'}`}>
                                                        å· {i + 1}
                                                    </div>
                                                    {status.completed ? (
                                                        <div className="flex flex-col items-center">
                                                            <div className="bg-green-100 text-green-600 p-1 rounded-full mb-1">
                                                                <Icon path={icons.check} className="w-6 h-6"/>
                                                            </div>
                                                            <span className="text-sm font-mono text-green-600 font-bold bg-green-100/50 px-2 py-0.5 rounded">{status.date}</span>
                                                        </div>
                                                    ) : (
                                                        <div className="text-gray-300 group-hover:text-amber-400 transition-colors">
                                                            <Icon path={icons.lock} className="w-8 h-8"/>
                                                        </div>
                                                    )}
                                                    {!status.completed && (
                                                        <div className="absolute inset-0 bg-black/5 opacity-0 group-hover:opacity-100 transition-opacity rounded-xl flex items-center justify-center">
                                                            <span className="bg-white px-3 py-1 rounded-full text-xs font-bold text-amber-600 shadow-sm">æŒ‘æˆ°</span>
                                                        </div>
                                                    )}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>

                            {/* Main Cards */}
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {/* å­¸ç¿’æ¨¡å¼ */}
                                <div className="bg-white/90 backdrop-blur rounded-2xl p-6 shadow-md border-2 border-amber-100 hover:border-amber-300 transition-all group relative overflow-hidden cursor-pointer" onClick={() => { onStartLearn('ç²¾é¸æˆèª'); triggerMusic(); }}>
                                    <div className="absolute -right-6 -top-6 w-24 h-24 bg-amber-100 rounded-full opacity-50 group-hover:scale-150 transition-transform duration-500"></div>
                                    <h3 className="text-2xl font-black text-amber-900 mb-2 relative z-10">ğŸ“– ç ”è®€æˆèª</h3>
                                    <p className="text-gray-500 mb-6 relative z-10 h-12 text-sm">ç€è¦½æ‰€æœ‰æˆèªï¼Œå­¸ç¿’é‡‹ç¾©èˆ‡ä¾‹å¥ã€‚</p>
                                    <button className="w-full bg-amber-100 hover:bg-amber-200 text-amber-800 py-3 rounded-xl font-bold transition-colors flex items-center justify-center relative z-10">
                                        <Icon path={icons.book} className="w-5 h-5 mr-2"/> é–‹å§‹ç ”è®€
                                    </button>
                                </div>

                                {/* ç€‘å¸ƒåˆ·é¡Œ (æ–°å¢) */}
                                <div className="bg-white/90 backdrop-blur rounded-2xl p-6 shadow-md border-2 border-cyan-100 hover:border-cyan-300 transition-all group relative overflow-hidden cursor-pointer" onClick={() => { onStartWaterfall(); triggerMusic(); }}>
                                    <div className="absolute -right-6 -top-6 w-24 h-24 bg-cyan-100 rounded-full opacity-50 group-hover:scale-150 transition-transform duration-500"></div>
                                    <h3 className="text-2xl font-black text-cyan-900 mb-2 relative z-10 flex items-center"><Icon path={icons.activity} className="w-6 h-6 mr-2 text-cyan-600"/> ç€‘å¸ƒåˆ·é¡Œ</h3>
                                    <p className="text-gray-500 mb-6 relative z-10 h-12 text-sm">å…¨ç¯„åœéš¨æ©Ÿå‡ºé¡Œï¼Œç„¡ç›¡æ¨¡å¼æŒ‘æˆ°æ¥µé™ã€‚</p>
                                    <button className="w-full bg-cyan-500 hover:bg-cyan-600 text-white py-3 rounded-xl font-bold shadow-md transition-colors flex items-center justify-center relative z-10">
                                        <Icon path={icons.play} className="w-5 h-5 mr-2" fill="currentColor"/> ç«‹å³æŒ‘æˆ°
                                    </button>
                                </div>

                                {/* æˆ‘çš„æ”¶è— */}
                                <div className="bg-white/90 backdrop-blur rounded-2xl p-6 shadow-md border-2 border-rose-100 hover:border-rose-300 transition-all group relative overflow-hidden">
                                    <div className="absolute -right-6 -top-6 w-24 h-24 bg-rose-100 rounded-full opacity-50 group-hover:scale-150 transition-transform duration-500"></div>
                                    <div className="flex justify-between items-start relative z-10 mb-2">
                                        <h3 className="text-2xl font-black text-rose-900 flex items-center"><Icon path={icons.heart} className="w-6 h-6 mr-2 text-rose-500" fill="currentColor"/> æ”¶è—å¤¾</h3>
                                        <span className="bg-rose-100 text-rose-600 text-xs font-bold px-2 py-1 rounded-full">{favorites.length}</span>
                                    </div>
                                    <p className="text-gray-500 mb-6 relative z-10 h-12 text-sm">è¤‡ç¿’æ‚¨æ”¶è—çš„é‡é»æˆèªã€‚</p>
                                    <div className="flex gap-2 relative z-10">
                                        <button onClick={() => { onStartLearn('æ”¶è—å¤¾'); triggerMusic(); }} disabled={favorites.length===0} className="flex-1 bg-rose-50 hover:bg-rose-100 text-rose-700 py-3 rounded-xl font-bold transition-colors flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                                            <Icon path={icons.book} className="w-4 h-4 mr-1"/> æº«æ•…
                                        </button>
                                        <button onClick={() => { onStartQuiz('æ”¶è—å¤¾'); triggerMusic(); }} disabled={favorites.length===0} className="flex-1 bg-rose-500 hover:bg-rose-600 text-white py-3 rounded-xl font-bold shadow-md transition-colors flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                                            <Icon path={icons.play} className="w-4 h-4 mr-1"/> çŸ¥æ–°
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Secondary Actions Grid */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <button onClick={onViewTable} className="bg-white/80 hover:bg-purple-50 border-2 border-purple-100 hover:border-purple-300 p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center gap-2 transition-all group">
                                    <div className="bg-purple-100 text-purple-500 p-3 rounded-full mb-1 shadow-sm group-hover:scale-110 transition-transform"><Icon path={icons.list} className="w-6 h-6"/></div>
                                    <span className="font-bold text-gray-700">æˆèªç¸½è¦½</span>
                                </button>

                                <button onClick={onViewMistakes} className="bg-white/80 hover:bg-red-50 border-2 border-red-100 hover:border-red-300 p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center gap-2 transition-all">
                                    <div className="bg-red-100 text-red-500 p-3 rounded-full mb-1"><Icon path={icons.alert} className="w-6 h-6"/></div>
                                    <span className="font-bold text-gray-700">éŒ¯é¡Œæœ¬</span>
                                    <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full">{mistakeLog.length}</span>
                                </button>

                                <button onClick={onViewHistory} className="bg-white/80 hover:bg-blue-50 border-2 border-blue-100 hover:border-blue-300 p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center gap-2 transition-all">
                                    <div className="bg-blue-100 text-blue-500 p-3 rounded-full mb-1"><Icon path={icons.history} className="w-6 h-6"/></div>
                                    <span className="font-bold text-gray-700">æˆ°ç¸¾è¡¨</span>
                                </button>

                                <button onClick={onPrint} className="bg-white/80 hover:bg-gray-50 border-2 border-gray-200 hover:border-gray-400 p-4 rounded-2xl shadow-sm flex flex-col items-center justify-center gap-2 transition-all">
                                    <div className="bg-gray-100 text-gray-600 p-3 rounded-full mb-1"><Icon path={icons.print} className="w-6 h-6"/></div>
                                    <span className="font-bold text-gray-700">åˆ—å°è€ƒå·</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div className="mt-12 text-center text-gray-500 text-sm font-medium bg-white/50 backdrop-blur rounded-full py-2 inline-block px-6 mx-auto w-full md:w-auto">
                        &copy; 2025 æˆèªå¤§å¸« â€¢ äº’å‹•å¼å­¸ç¿’ç³»çµ±
                    </div>
                </div>
            );
        };

        const MistakeView = ({ mistakes, mistakeLog, setMistakeLog, onMenu, onReviewAll }) => {
            return (
                <div className="max-w-7xl mx-auto px-4 py-8 mt-12 animate-fade-in-up">
                    <div className="flex flex-col md:flex-row items-start md:items-center justify-between mb-8 gap-4">
                        <div className="flex items-center">
                            <button onClick={onMenu} className="mr-4 p-3 bg-white rounded-xl shadow border border-gray-200 hover:bg-gray-50"><Icon path={icons.left} className="w-5 h-5"/></button>
                            <h2 className="text-3xl font-black text-gray-800 flex items-center"><Icon path={icons.alert} className="w-8 h-8 text-red-500 mr-3"/> éŒ¯é¡Œè»ä»¤ç‹€</h2>
                        </div>
                        {mistakes.length > 0 && (
                            <div className="flex gap-2">
                                <button onClick={onReviewAll} className="px-6 py-3 bg-red-600 text-white rounded-xl shadow-lg hover:bg-red-700 font-bold flex items-center justify-center">
                                    <Icon path={icons.play} className="w-5 h-5 mr-2" fill="currentColor"/>
                                    ç«‹å³è¤‡ç¿’ ({mistakes.length})
                                </button>
                                <button onClick={() => {if(confirm('ç¢ºå®šæ¸…ç©ºéŒ¯é¡Œæœ¬ï¼Ÿé€™å°‡ç§»é™¤æ‰€æœ‰éŒ¯èª¤ç´€éŒ„ã€‚')) { setMistakeLog([]); } }} className="px-6 py-3 bg-white text-gray-500 rounded-xl shadow border border-gray-200 hover:bg-gray-50 font-bold">
                                    <Icon path={icons.trash} className="w-5 h-5"/>
                                </button>
                            </div>
                        )}
                    </div>

                    {mistakes.length === 0 ? (
                        <div className="text-center py-32 bg-white/80 backdrop-blur rounded-3xl shadow-sm border border-green-100">
                            <div className="text-8xl mb-6">ğŸ‰</div>
                            <p className="text-2xl text-gray-800 font-black mb-2">å¤ªæ£’äº†ï¼</p>
                            <p className="text-gray-500">ç›®å‰æ²’æœ‰éŒ¯é¡Œç´€éŒ„ï¼Œç¹¼çºŒä¿æŒï¼</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {mistakes.map(item => { 
                                const log = mistakeLog.find(m => m.id === item.id); 
                                return (
                                    <div key={item.id} className="bg-white rounded-2xl p-6 shadow-sm border-2 border-transparent hover:border-red-200 hover:shadow-md transition-all relative overflow-hidden group flex flex-col">
                                        <div className="flex justify-between items-start mb-3">
                                            <h3 className="text-3xl font-black text-gray-800">{item.term}</h3>
                                            <span className="bg-red-100 text-red-600 text-xs font-bold px-3 py-1 rounded-full border border-red-200 whitespace-nowrap">
                                                éŒ¯èª¤ {log.count} æ¬¡
                                            </span>
                                        </div>
                                        <p className="text-gray-600 text-sm leading-relaxed mb-4 flex-1">{item.definition}</p>
                                        
                                        <div className="border-t border-gray-100 pt-3 flex justify-between items-center text-xs text-gray-400 font-mono mt-auto">
                                            <span>#{String(item.id).padStart(3,'0')}</span>
                                            <span>{new Date(log.lastMissed).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                ); 
                            })}
                        </div>
                    )}
                </div>
            );
        };

        const TableView = ({ items, onMenu, favorites, toggleFavorite }) => {
            const [searchTerm, setSearchTerm] = useState("");
            const filteredItems = useMemo(() => {
                if (!searchTerm.trim()) return items;
                const lowerTerm = searchTerm.toLowerCase();
                return items.filter(item => String(item.id).includes(lowerTerm) || item.term.includes(lowerTerm) || item.definition.includes(lowerTerm) || item.sentence1.includes(lowerTerm));
            }, [items, searchTerm]);

            return (
                <div className="max-w-7xl mx-auto px-4 py-8 animate-fade-in-up mt-12 no-print">
                    <div className="bg-white/95 backdrop-blur-md rounded-2xl shadow-xl overflow-hidden border border-gray-200 flex flex-col h-[85vh]">
                        <div className="p-6 border-b border-gray-200 bg-gray-50 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-4 w-full md:w-auto">
                                <button onClick={onMenu} className="flex items-center text-gray-600 hover:text-gray-900 font-bold bg-white border border-gray-300 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors shadow-sm"><Icon path={icons.left} className="w-5 h-5 mr-2"/> è¿”å›</button>
                                <h2 className="text-2xl font-black text-gray-800 flex items-center"><Icon path={icons.list} className="w-6 h-6 mr-3 text-purple-600"/> æˆèªä¸€è¦½è¡¨ <span className="ml-3 text-sm font-normal text-gray-500 bg-gray-200 px-2 py-1 rounded-full">å…± {items.length} å‰‡</span></h2>
                            </div>
                            <div className="relative w-full md:w-96">
                                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400"><Icon path={icons.search} className="w-5 h-5"/></div>
                                <input type="text" placeholder="æœå°‹åç¨±ã€ç·¨è™Ÿ..." className="pl-10 pr-4 py-3 border-2 border-gray-300 rounded-xl w-full focus:ring-4 focus:ring-purple-100 focus:border-purple-500 outline-none transition-all" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                            </div>
                        </div>
                        <div className="flex-1 overflow-auto bg-white p-0">
                            <table className="w-full text-left border-collapse prose-table">
                                <thead className="bg-purple-50 sticky top-0 z-10 shadow-sm"><tr><th className="p-2 text-center w-12">æ”¶è—</th><th className="p-2 text-center w-12">ç·¨è™Ÿ</th><th className="p-4 w-48">æˆèªåç¨±</th><th className="p-4">é‡‹ç¾©</th><th className="p-4 w-96">æ‡‰ç”¨ç¯„ä¾‹</th></tr></thead>
                                <tbody className="divide-y divide-gray-100">{filteredItems.map(item => (<tr key={item.id} className="hover:bg-purple-50/50 transition-colors"><td className="p-2 text-center"><button onClick={() => toggleFavorite(item.id)}><Icon path={icons.heart} className={`w-6 h-6 ${favorites.includes(item.id) ? "text-red-500" : "text-gray-300 hover:text-red-400"}`} fill={favorites.includes(item.id) ? "currentColor" : "none"} /></button></td><td className="p-2 text-center font-mono text-gray-500">{item.id}</td><td className="p-4 font-bold text-gray-900">{item.term}</td><td className="p-4 text-gray-600 text-sm">{item.definition}</td><td className="p-4 text-gray-500 italic text-sm">{item.sentence1}</td></tr>))}</tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const LearnView = ({ items, learnPage, setLearnPage, favorites, toggleFavorite, completedDays, onMenu }) => {
            const totalPages = Math.ceil(items.length / ITEMS_PER_PAGE);
            const currentItems = items.slice(learnPage * ITEMS_PER_PAGE, (learnPage + 1) * ITEMS_PER_PAGE);
            const scrollRef = useRef(null);
            useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = 0; window.scrollTo(0, 0); }, [learnPage]);

            return (
                <div className="max-w-4xl mx-auto px-4 py-6 mt-12 no-print" ref={scrollRef}>
                    <div className="bg-white/90 backdrop-blur-md p-4 rounded-xl shadow-sm mb-8 flex flex-col md:flex-row justify-between items-center sticky top-16 z-30 border-b-2 border-amber-200">
                        <div className="flex items-center gap-4 mb-4 md:mb-0 w-full md:w-auto">
                            <button onClick={onMenu} className="text-gray-500 hover:text-gray-900 flex items-center whitespace-nowrap bg-gray-100 px-3 py-2 rounded-lg font-bold"><Icon path={icons.menu} className="w-5 h-5 mr-2"/> é¸å–®</button>
                            <h2 className="text-2xl font-black flex items-center whitespace-nowrap text-amber-900">ğŸ“– å…¸æ•…å·è»¸</h2>
                        </div>
                        <div className="flex overflow-x-auto overflow-y-hidden max-w-full w-full md:w-auto pb-2 md:pb-0 gap-2 mt-2 md:mt-0">
                            {Array.from({ length: totalPages }).map((_, i) => (<button key={i} onClick={() => setLearnPage(i)} className={`px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap flex items-center gap-2 transition-all flex-shrink-0 ${learnPage === i ? 'bg-amber-600 text-white shadow-md transform scale-105' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>å· {i + 1} {completedDays.some(item => item.id === `ç²¾é¸æˆèª-${i}`) && <span className="bg-green-400 text-white text-[10px] px-1.5 py-0.5 rounded-full">âœ“</span>}</button>))}
                        </div>
                    </div>
                    <div className="space-y-8">
                        {currentItems.map((item, idx) => (
                            <div key={item.id} className="bg-white/95 backdrop-blur-sm rounded-2xl p-6 md:p-8 shadow-sm border border-amber-100 relative group hover:shadow-lg transition-all animate-fade-in-up" style={{animationDelay: `${idx * 0.05}s`}}>
                                <button onClick={() => toggleFavorite(item.id)} className="absolute top-6 right-6 text-gray-200 hover:text-red-500 z-10 transition-colors"><Icon path={icons.heart} className={`w-8 h-8 drop-shadow-sm ${favorites.includes(item.id) ? "text-red-500" : ""}`} fill={favorites.includes(item.id) ? "currentColor" : "none"} /></button>
                                <div className="flex flex-col md:flex-row gap-8">
                                    <div className="flex-1">
                                        <div className="flex items-baseline gap-3 mb-3 flex-wrap pr-10"><span className="text-amber-300 font-mono text-xl font-black">#{String(item.id).padStart(3,'0')}</span><h3 className="text-3xl font-black text-gray-900 tracking-tight">{item.term}</h3></div>
                                        <div className="bg-gradient-to-r from-amber-50 to-transparent p-4 rounded-xl text-amber-900 mb-6 text-lg font-medium border-l-8 border-amber-400">{item.definition}</div>
                                        <div className="text-gray-600 leading-relaxed pl-4 italic border-l-4 border-gray-300 text-lg bg-gray-50 py-2 pr-2 rounded-r-lg"><span className="font-bold not-italic text-gray-400 mr-2 text-sm">æ‡‰ç”¨ç¯„ä¾‹</span>{item.sentence1}</div>
                                    </div>
                                    <div className="w-full md:w-96 flex-shrink-0 flex flex-col items-center"><div className="bg-white p-2 border-2 border-gray-100 rounded-2xl w-full shadow-sm"><div className="rounded-xl overflow-hidden bg-gray-200 aspect-[4/2.8] relative group-img cursor-pointer w-full"><img src={`Chinese-Idiom5-images/p${String(item.id).padStart(3, '0')}.jpg`} alt={item.scene} loading="lazy" className="w-full h-full object-cover transition-transform duration-700 hover:scale-110" onError={(e) => { e.target.onerror = null; e.target.parentNode.innerHTML = `<div class="w-full h-full flex flex-col items-center justify-center bg-gray-100 text-gray-400 p-4 text-center"><span class="text-sm font-bold text-gray-500">${item.scene}</span></div>`; }} /></div></div></div>
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="h-20"></div>
                </div>
            );
        };

        const QuizView = ({ questions, score, userName, combo, onAnswer, onFinish, onMenu, onViewHistory, favorites, toggleFavorite, totalItems, quizPage, onPageChange, completedDays, activeCategory }) => {
            const [showResult, setShowResult] = useState(false);
            const isFinished = questions.length > 0 && questions.every(q => q.userAnswer !== null);
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            
            // å¦‚æœæ˜¯ç€‘å¸ƒæ¨¡å¼ï¼Œä¸é¡¯ç¤ºä¸Šæ–¹çš„åˆ†é æŒ‰éˆ•
            const isWaterfall = activeCategory === 'waterfall';

            useEffect(() => { if (isFinished && !showResult) { const timer = setTimeout(() => { onFinish(); setShowResult(true); }, 800); return () => clearTimeout(timer); } }, [isFinished]);

            if (showResult) {
                 return (
                    <div className="max-w-2xl mx-auto pt-10 px-4 animate-fade-in-up mt-12 no-print">
                        <div className="bg-white rounded-3xl shadow-2xl overflow-hidden text-center border-4 border-amber-400">
                            <div className="bg-amber-500 p-10 text-white relative overflow-hidden"><h2 className="text-4xl font-black mb-2 font-serif relative z-10">æˆ°å½¹çµæŸ</h2><p className="opacity-90 font-bold text-lg relative z-10">ä¸»å…¬ {userName} è¾›è‹¦äº†</p></div>
                            <div className="p-10">
                                <div className="text-8xl font-black text-amber-600 mb-2 font-mono tracking-tighter">{score} <span className="text-3xl text-gray-300 font-bold">/ {questions.length}</span></div>
                                <div className="flex justify-center gap-4 mb-10"><div className="flex-1 bg-green-50 text-green-700 py-4 rounded-2xl font-black text-xl border-2 border-green-200">å¤§æ· {score}</div><div className="flex-1 bg-red-50 text-red-700 py-4 rounded-2xl font-black text-xl border-2 border-red-200">å¤±åˆ© {questions.length - score}</div></div>
                                <div className="flex flex-col gap-4"><button onClick={onMenu} className="w-full py-4 bg-gray-100 hover:bg-gray-200 rounded-2xl font-black text-gray-700 text-xl transition-colors">è¿”å›å¤§ç‡Ÿ</button><button onClick={onViewHistory} className="w-full py-4 bg-amber-600 hover:bg-amber-700 rounded-2xl font-black text-white shadow-xl shadow-amber-200 text-xl transition-all transform active:scale-95">æŸ¥çœ‹è©³ç´°æˆ°å ±</button></div>
                            </div>
                        </div>
                    </div>
                );
            }
            return (
                <div className="max-w-4xl mx-auto pb-20 px-4 mt-12 no-print">
                    <div className="bg-white/95 backdrop-blur shadow-sm p-4 rounded-b-2xl mb-8 sticky top-16 z-30 border-t-4 border-amber-500 flex flex-col md:flex-row justify-between items-center transition-all">
                        <div className="flex items-center gap-4 mb-4 md:mb-0 w-full md:w-auto justify-between md:justify-start">
                            <button onClick={onMenu} className="text-gray-500 text-sm flex items-center hover:text-red-600 font-bold bg-gray-100 px-3 py-2 rounded-lg transition-colors"><Icon path={icons.left} className="w-4 h-4 mr-1"/> æ’¤é€€</button>
                            <div className="font-bold text-xl flex items-center gap-3">
                                <span>{userName}</span>
                                <span className="bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-sm font-black border border-amber-200">
                                    {isWaterfall ? 'ç€‘å¸ƒæ¨¡å¼' : `æˆ°åŠŸ: ${score}`}
                                </span>
                            </div>
                        </div>
                        
                        {/* åªæœ‰éç€‘å¸ƒæ¨¡å¼æ‰é¡¯ç¤ºåˆ†é  */}
                        {!isWaterfall && (
                            <div className="flex overflow-x-auto overflow-y-hidden max-w-full w-full md:w-auto pb-1 md:pb-0 gap-2">
                                {Array.from({ length: totalPages }).map((_, i) => (
                                    <button key={i} onClick={() => onPageChange(i)} className={`px-3 py-1.5 rounded-md text-xs font-bold whitespace-nowrap flex items-center gap-1 transition-all flex-shrink-0 ${quizPage === i ? 'bg-amber-600 text-white shadow-md' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}>å·{i + 1}{completedDays.some(item => item.id === `ç²¾é¸æˆèª-${i}`) && <span className="bg-green-400 text-white text-[10px] w-3 h-3 flex items-center justify-center rounded-full">âœ“</span>}</button>
                                ))}
                            </div>
                        )}
                    </div>
                    <div className="space-y-8">
                        {questions.map((q, idx) => (
                            <div key={idx} className={`bg-white/95 backdrop-blur-sm rounded-3xl shadow-sm border-4 overflow-hidden transition-all duration-500 relative ${q.userAnswer === null ? 'border-transparent shadow-md' : (q.isCorrect ? 'border-green-200 bg-green-50/20' : 'border-red-200 bg-red-50/20')}`}>
                                <button onClick={() => toggleFavorite(q.id)} className="absolute top-5 right-5 z-10 transition-colors p-2 rounded-full bg-white/50 hover:bg-white"><Icon path={icons.heart} className={`w-7 h-7 ${favorites.includes(q.id) ? 'text-red-500' : 'text-gray-300'}`} fill={favorites.includes(q.id) ? "currentColor" : "none"} /></button>
                                <div className="p-8 border-b border-gray-100">
                                    <div className="flex justify-between items-center mb-6"><span className="font-black text-amber-900 tracking-wider text-sm bg-amber-100 px-3 py-1 rounded-full border border-amber-200">å•é¡Œ {idx + 1}</span>{q.userAnswer !== null && (q.isCorrect ? <span className="text-green-600 font-black flex items-center text-lg animate-pop mr-12"><Icon path={icons.check} className="w-6 h-6 mr-1"/> æ­£ç¢º</span> : <span className="text-red-600 font-black flex items-center text-lg animate-shake mr-12"><Icon path={icons.alert} className="w-6 h-6 mr-1"/> éŒ¯èª¤</span>)}</div>
                                    <div className="text-2xl md:text-3xl font-bold text-gray-800 leading-relaxed text-justify">
                                        {q.sentence2 && q.sentence2.includes(q.term) ? 
                                            q.sentence2.split(q.term).map((part, i, arr) => (
                                                <span key={i}>
                                                    {part}
                                                    {i < arr.length - 1 && (
                                                        <span className="inline-block min-w-[140px] border-b-4 border-gray-400 mx-2 align-bottom text-center px-1 relative -top-1">
                                                            {q.userAnswer !== null && q.isCorrect ? 
                                                                <span className="text-amber-700 animate-pop inline-block">{q.term}</span> : 
                                                                <span className="opacity-0 select-none">{q.term}</span>
                                                            }
                                                            {q.userAnswer !== null && !q.isCorrect && (
                                                                <span className="absolute -top-8 left-0 w-full text-center text-sm text-green-600 font-bold whitespace-nowrap animate-bounce">
                                                                    {q.term}
                                                                </span>
                                                            )}
                                                        </span>
                                                    )}
                                                </span>
                                            )) 
                                            : <span>{q.sentence2 || q.definition}</span>
                                        }
                                    </div>
                                </div>
                                <div className="p-6 bg-gray-50/50"><div className="grid grid-cols-1 md:grid-cols-2 gap-4">{q.options.map(opt => { let btnClass = "p-5 rounded-2xl border-2 text-left font-bold text-xl transition-all relative overflow-hidden "; if (q.userAnswer === null) btnClass += "bg-white border-gray-200 hover:border-amber-400 hover:shadow-md cursor-pointer active:scale-[0.98] text-gray-700"; else { if (opt.id === q.id) btnClass += "bg-green-100 border-green-500 text-green-800 ring-2 ring-green-200 shadow-md"; else if (opt.id === q.userAnswer) btnClass += "bg-red-100 border-red-500 text-red-800 opacity-80"; else btnClass += "bg-gray-50 border-gray-200 text-gray-300 opacity-40 grayscale"; } return (<button key={opt.id} onClick={() => onAnswer(idx, opt.id)} disabled={q.userAnswer !== null} className={btnClass}>{opt.term}{q.userAnswer !== null && opt.id === q.id && <div className="absolute right-4 top-1/2 -translate-y-1/2 text-green-600 bg-white rounded-full p-1"><Icon path={icons.check} className="w-5 h-5"/></div>}</button>)})}</div></div>
                                
                                {q.userAnswer !== null && !q.isCorrect && (
                                    <div className="p-6 bg-red-50/50 border-t border-red-100 animate-fade-in-up">
                                        <div className="bg-white rounded-xl p-5 border border-red-200 flex flex-col md:flex-row gap-5 items-start shadow-sm">
                                            <div className="w-full md:w-40 aspect-video rounded-lg overflow-hidden border border-gray-200 bg-gray-100 flex-shrink-0">
                                                <img 
                                                    src={`Chinese-Idiom5-images/p${String(q.id).padStart(3, '0')}.jpg`}
                                                    className="w-full h-full object-cover" 
                                                    onError={(e) => {
                                                        e.target.onerror = null; 
                                                        e.target.parentNode.innerHTML = `<div class="w-full h-full flex items-center justify-center bg-gray-100 text-gray-400 text-xs p-2 text-center">${q.scene || 'ç„¡åœ–ç‰‡'}</div>`;
                                                    }}
                                                />
                                            </div>
                                            <div className="flex-1">
                                                <div className="text-sm font-black text-red-800 mb-1 flex items-center gap-2 uppercase tracking-wide">
                                                    <Icon path={icons.book} className="w-4 h-4"/> æˆèªé‡‹ç¾©
                                                </div>
                                                <div className="flex items-center gap-2 mb-2">
                                                    <div className="text-2xl font-black text-gray-900">{q.term}</div>
                                                </div>
                                                <div className="text-gray-700 text-base leading-relaxed">{q.definition}</div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const HistoryView = ({ historyLog, setHistoryLog, onMenu }) => {
            const [selectedLog, setSelectedLog] = useState(null);
            if (selectedLog) {
                return (
                    <div className="w-full max-w-4xl mx-auto bg-white/95 backdrop-blur-md min-h-screen p-6 md:p-8 shadow-2xl animate-fade-in-up mt-12 no-print">
                        <div className="flex justify-between items-center mb-8 pb-4 border-b border-gray-200 sticky top-16 bg-white z-20 pt-4"><button onClick={() => setSelectedLog(null)} className="flex items-center text-gray-500 hover:text-amber-800 font-bold text-lg px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors"><Icon path={icons.left} className="w-6 h-6 mr-1"/> è¿”å›</button><div className="text-right"><h2 className="text-2xl font-black text-gray-800">æˆ°å½¹å›æ”¾</h2><p className="text-gray-500 text-sm mt-1 font-mono">{selectedLog.date}</p></div></div>
                        <div className="space-y-6"><div className="flex justify-center mb-8"><div className="text-center"><div className="text-sm text-gray-400 font-bold uppercase mb-1">ç¸½å¾—åˆ†</div><div className="text-5xl font-black text-amber-600">{selectedLog.score} <span className="text-2xl text-gray-300">/ {selectedLog.total}</span></div></div></div>{selectedLog.details.map((d, i) => (<div key={i} className={`p-6 rounded-2xl border-l-8 shadow-sm ${d.isCorrect ? 'border-green-400 bg-green-50/30' : 'border-red-400 bg-red-50/30'}`}><div className="mb-3 font-bold text-gray-800 text-xl leading-relaxed">{d.sentence}</div><div className="flex flex-col md:flex-row md:items-center gap-2 md:gap-6 bg-white/50 p-3 rounded-lg"><div className="flex items-center"><span className="text-gray-400 text-xs font-bold uppercase mr-2">æ‚¨çš„é¸æ“‡</span><span className={`text-lg font-bold ${d.isCorrect ? "text-green-700" : "text-red-600 line-through decoration-2"}`}>{d.userAnswer}</span></div>{!d.isCorrect && (<div className="flex items-center"><span className="text-gray-400 text-xs font-bold uppercase mr-2">æ­£è§£</span><span className="text-green-700 text-lg font-black">{d.correctAnswer}</span></div>)}</div></div>))}</div>
                        <div className="h-20"></div>
                    </div>
                )
            }
            return (
                <div className="max-w-4xl mx-auto px-4 py-8 mt-12 no-print">
                    <div className="flex items-center mb-8"><button onClick={onMenu} className="mr-4 p-3 bg-white rounded-xl shadow border border-gray-200 hover:bg-gray-50"><Icon path={icons.left} className="w-5 h-5"/></button><h2 className="text-3xl font-black text-gray-800 flex items-center gap-3">ğŸ“œ æ­·å²æˆ°ç¸¾ <span className="text-sm font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded-full">{historyLog.length} å ´</span></h2></div>
                    {historyLog.length === 0 ? <div className="text-center py-32 text-gray-400 border-2 border-dashed border-gray-200 rounded-3xl bg-white/80 backdrop-blur"><Icon path={icons.history} className="w-16 h-16 mx-auto mb-4 text-gray-300"/><p className="text-xl font-bold">å°šç„¡æˆ°å½¹ç´€éŒ„</p></div> : <div className="bg-white/95 backdrop-blur-md rounded-3xl shadow-lg overflow-hidden border border-gray-200"><table className="w-full text-left border-collapse"><thead className="bg-amber-50 border-b border-amber-100"><tr><th className="p-5 font-black text-amber-900 text-sm uppercase tracking-wider hidden md:table-cell">æ—¥æœŸ</th><th className="p-5 font-black text-amber-900 text-sm uppercase tracking-wider">ä¸»å…¬</th><th className="p-5 font-black text-amber-900 text-sm uppercase tracking-wider">æˆ°åŠŸ</th><th className="p-5 text-right">æ“ä½œ</th></tr></thead><tbody className="divide-y divide-gray-100">{historyLog.map(log => (<tr key={log.id} className="hover:bg-amber-50/50 transition-colors"><td className="p-5 text-gray-500 text-sm font-mono hidden md:table-cell">{log.date.split(',')[0]}</td><td className="p-5 font-bold text-gray-800">{log.userName}</td><td className="p-5"><span className="font-black px-3 py-1 rounded-lg text-sm bg-gray-100 text-gray-700 border border-gray-200">{log.score} <span className="text-gray-400 font-normal">/ {log.total}</span></span></td><td className="p-5 text-right"><button onClick={() => setSelectedLog(log)} className="text-amber-600 hover:text-white hover:bg-amber-600 px-4 py-2 rounded-lg text-sm font-bold transition-all border border-amber-200 hover:border-amber-600">æŸ¥çœ‹</button></td></tr>))}</tbody></table></div>}
                    <div className="text-center mt-12 pb-10"><button onClick={() => {if(confirm('ç¢ºå®šç„šæ¯€æ‰€æœ‰æˆ°å ±ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) setHistoryLog([])}} className="text-red-400 hover:text-red-600 text-sm flex items-center justify-center mx-auto hover:bg-red-50/80 px-4 py-2 rounded-lg transition-colors"><Icon path={icons.trash} className="w-4 h-4 mr-2"/> æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button></div>
                </div>
            );
        };

        // App Component
        const App = () => {
            const parsedData = useMemo(() => ({ "ç²¾é¸æˆèª": IDIOM_DATA }), []);
            const allItems = IDIOM_DATA;
            const [currentMode, setCurrentMode] = useState('menu'); 
            const [activeCategory, setActiveCategory] = useState(null);
            const [showNameWarning, setShowNameWarning] = useState(false);
            const [userName, setUserName] = useState('');
            const [isLocked, setIsLocked] = useState(false);
            const [connectionStatus, setConnectionStatus] = useState('loading'); 
            const [isFirebaseReady, setIsFirebaseReady] = useState(false);
            const [globalUsers, setGlobalUsers] = useState([]);
            const [favorites, setFavorites] = useState([]);
            const [historyLog, setHistoryLog] = useState([]);
            const [mistakeLog, setMistakeLog] = useState([]);
            const [completedDays, setCompletedDays] = useState([]);
            // åˆ†é›¢æš«å­˜ç‹€æ…‹
            const [savedLevelSession, setSavedLevelSession] = useState(null);
            const [savedWaterfallSession, setSavedWaterfallSession] = useState(null);
            
            const [learnPage, setLearnPage] = useState(0);
            const [quizQuestions, setQuizQuestions] = useState([]);
            const [quizScore, setQuizScore] = useState(0);
            const [combo, setCombo] = useState(0);
            const [quizPage, setQuizPage] = useState(0);
            const [lastUser, setLastUser] = useState(null);
            const [bgImage, setBgImage] = useState('');
            const musicPlayerRef = useRef(null);

            const triggerMusic = () => { if(musicPlayerRef.current) musicPlayerRef.current.triggerPlay(); };

            useEffect(() => { const randomNum = Math.floor(Math.random() * 5) + 1; setBgImage(`Chinese-Idiom5-images/san${randomNum}.jpg`); }, []);

            useEffect(() => {
                if (!isFirebaseInitialized) { setConnectionStatus('error'); return; }
                const initAuth = async () => {
                    try {
                        setConnectionStatus('loading');
                        await signInAnonymously(auth);
                        setIsFirebaseReady(true);
                        setConnectionStatus('success');
                        const globalDocRef = doc(db, COLLECTION_NAME, DOC_GLOBAL);
                        const unsubscribeGlobal = onSnapshot(globalDocRef, (docSnap) => {
                            if (docSnap.exists()) { setGlobalUsers(docSnap.data().users || []); } 
                            else { setDoc(globalDocRef, { users: [] }, { merge: true }); }
                        }, () => setConnectionStatus('error'));
                        return unsubscribeGlobal;
                    } catch (error) { setConnectionStatus('error'); setIsFirebaseReady(false); }
                };
                const unsub = initAuth();
                return () => { if(typeof unsub === 'function') unsub(); };
            }, []);

            useEffect(() => {
                if (!isFirebaseReady || !userName || !isLocked) return;
                const userDocRef = doc(db, COLLECTION_NAME, userName);
                const unsubscribeUser = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setFavorites(data.favorites || []);
                        setHistoryLog(data.history || []);
                        setMistakeLog(data.mistakes || []);
                        
                        const loadedProgress = data.progress || [];
                        const formattedProgress = loadedProgress.map(item => {
                            if (typeof item === 'string') {
                                return { id: item, date: 'èˆŠç´€éŒ„', score: 0 };
                            }
                            return item;
                        });
                        setCompletedDays(formattedProgress);
                        
                        // åˆ†é›¢è®€å–ï¼šèˆŠè³‡æ–™ç›¸å®¹ (currentQuizSession å¯èƒ½ç‚ºèˆŠæ ¼å¼ï¼Œæ­¸é¡ç‚º Level)
                        setSavedLevelSession(data.currentLevelSession || data.currentQuizSession || null);
                        setSavedWaterfallSession(data.currentWaterfallSession || null);
                        
                        setConnectionStatus('success');
                    } else {
                        setDoc(userDocRef, { favorites: [], history: [], mistakes: [], progress: [], lastLogin: new Date().toISOString() }, { merge: true });
                    }
                }, () => setConnectionStatus('error'));
                return () => unsubscribeUser();
            }, [isFirebaseReady, userName, isLocked]);

            const updateUserData = async (field, value) => {
                if (!isFirebaseReady || !userName || !isLocked) return;
                try {
                    const userDocRef = doc(db, COLLECTION_NAME, userName);
                    await updateDoc(userDocRef, { [field]: value, lastUpdate: new Date().toISOString() });
                } catch (error) { console.error(`Error updating ${field}:`, error); setConnectionStatus('error'); }
            };

            const handleLogin = async () => { if (userName.trim()) { setIsLocked(true); setShowNameWarning(false); if (isFirebaseReady) { try { const globalDocRef = doc(db, COLLECTION_NAME, DOC_GLOBAL); await updateDoc(globalDocRef, { users: arrayUnion(userName) }); } catch (e) {} } } else { setShowNameWarning(true); } };
            const handleQuickLogin = (name) => { setUserName(name); setIsLocked(true); setShowNameWarning(false); };
            const handleLogout = () => { if(confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) { setIsLocked(false); setUserName(''); setFavorites([]); setHistoryLog([]); setMistakeLog([]); setCompletedDays([]); setSavedLevelSession(null); setSavedWaterfallSession(null); } };
            const handleDeleteUser = async () => { if (!isFirebaseReady) { alert("è«‹å…ˆé€£ç·šè‡³é›²ç«¯"); return; } if (confirm('ã€å±éšªæ“ä½œã€‘ç¢ºå®šè¦åˆªé™¤é€™ä½ä½¿ç”¨è€…çš„æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) { if (confirm('å†æ¬¡ç¢ºèªï¼šé€™å°‡æœƒæ¸…é™¤æ‰€æœ‰å­¸ç¿’ç´€éŒ„ã€æ”¶è—å’ŒéŒ¯é¡Œæœ¬ï¼Œä¸”ç„¡æ³•å¾©åŸï¼ç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ')) { try { const globalDocRef = doc(db, COLLECTION_NAME, DOC_GLOBAL); await updateDoc(globalDocRef, { users: arrayRemove(userName) }); const userDocRef = doc(db, COLLECTION_NAME, userName); await setDoc(userDocRef, { deleted: true }); setFavorites([]); setHistoryLog([]); setMistakeLog([]); setCompletedDays([]); setSavedLevelSession(null); setSavedWaterfallSession(null); setIsLocked(false); setUserName(''); } catch (e) { alert("åˆªé™¤å¤±æ•—"); } } } };
            const toggleFavorite = (id) => { const newFavorites = favorites.includes(id) ? favorites.filter(fid => fid !== id) : [...favorites, id]; setFavorites(newFavorites); updateUserData('favorites', newFavorites); };
            const clearHistoryLog = () => { setHistoryLog([]); updateUserData('history', []); };
            const clearMistakeLog = () => { setMistakeLog([]); updateUserData('mistakes', []); };

            const playSoundEffect = (type) => { try { const AudioContext = window.AudioContext || window.webkitAudioContext; if (!AudioContext) return; const ctx = new AudioContext(); const now = ctx.currentTime; if (type === 'correct') { const osc1 = ctx.createOscillator(); const gain1 = ctx.createGain(); osc1.type = 'sine'; osc1.frequency.setValueAtTime(523.25, now); gain1.gain.setValueAtTime(0.1, now); gain1.gain.exponentialRampToValueAtTime(0.001, now + 0.5); osc1.connect(gain1); gain1.connect(ctx.destination); osc1.start(now); osc1.stop(now + 0.5); const osc2 = ctx.createOscillator(); const gain2 = ctx.createGain(); osc2.type = 'sine'; osc2.frequency.setValueAtTime(659.25, now + 0.1); gain2.gain.setValueAtTime(0.1, now + 0.1); gain2.gain.exponentialRampToValueAtTime(0.001, now + 0.6); osc2.connect(gain2); gain2.connect(ctx.destination); osc2.start(now + 0.1); osc2.stop(now + 0.6); } else { const osc = ctx.createOscillator(); const gain = ctx.createGain(); osc.type = 'triangle'; osc.frequency.setValueAtTime(150, now); osc.frequency.exponentialRampToValueAtTime(50, now + 0.3); gain.gain.setValueAtTime(0.2, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3); osc.connect(gain); gain.connect(ctx.destination); osc.start(now); osc.stop(now + 0.3); } } catch (e) {} };

            // å•Ÿå‹•ä¸€èˆ¬é—œå¡ / æ”¶è— / éŒ¯é¡Œ
            const handleStartQuiz = (category, pageIdx = 0, isMistakeMode = false) => {
                if (!isLocked) { setShowNameWarning(true); return; }
                
                // è‡ªå‹•çºŒé—œ (Level Mode)
                if (savedLevelSession && savedLevelSession.category === (isMistakeMode ? 'éŒ¯é¡Œæœ¬' : category) && (isMistakeMode || savedLevelSession.pageIdx === pageIdx)) {
                    // ç›´æ¥è¼‰å…¥ï¼Œä¸è©¢å•
                    setQuizQuestions(savedLevelSession.questions);
                    setQuizScore(savedLevelSession.score);
                    setCombo(savedLevelSession.combo);
                    setQuizPage(savedLevelSession.pageIdx);
                    setActiveCategory(savedLevelSession.category);
                    setCurrentMode('quiz');
                    return;
                }

                let questions = [];
                if (isMistakeMode) { const mistakeIds = mistakeLog.map(m => m.id); questions = allItems.filter(i => mistakeIds.includes(i.id)); questions.sort(() => Math.random() - 0.5); } 
                else { 
                    let sourceItems = category === 'æ”¶è—å¤¾' ? allItems.filter(i => favorites.includes(i.id)) : parsedData["ç²¾é¸æˆèª"]; 
                    if (!sourceItems || sourceItems.length === 0) { alert("æ­¤åˆ†é¡å°šç„¡å…§å®¹ï¼"); return; } 
                    const start = pageIdx * ITEMS_PER_PAGE; 
                    if (start >= sourceItems.length && pageIdx > 0) { handleStartQuiz(category, Math.floor((sourceItems.length - 1) / ITEMS_PER_PAGE), isMistakeMode); return; } 
                    questions = sourceItems.slice(start, start + ITEMS_PER_PAGE); 
                }
                if (questions.length === 0) { alert(isMistakeMode ? "ç›®å‰æ²’æœ‰éŒ¯é¡Œï¼" : "æ­¤é é¢ç„¡é¡Œç›®"); return; }
                const quizSet = questions.map(item => { let pool = allItems.filter(i => i.id !== item.id); const distractors = pool.sort(() => Math.random() - 0.5).slice(0, 3); const options = [...distractors, item].sort(() => Math.random() - 0.5); return { ...item, options, userAnswer: null, isCorrect: null }; });
                setQuizQuestions(quizSet); setQuizScore(0); setCombo(0); setQuizPage(pageIdx); setActiveCategory(isMistakeMode ? 'éŒ¯é¡Œæœ¬' : category); setCurrentMode('quiz'); window.scrollTo(0,0);
            };

            // å•Ÿå‹•ç€‘å¸ƒåˆ·é¡Œ
            const handleStartWaterfall = () => {
                if (!isLocked) { setShowNameWarning(true); return; }

                // è‡ªå‹•çºŒé—œ (Waterfall Mode)
                if (savedWaterfallSession) {
                    setQuizQuestions(savedWaterfallSession.questions);
                    setQuizScore(savedWaterfallSession.score);
                    setCombo(savedWaterfallSession.combo);
                    setQuizPage(0); // ç€‘å¸ƒæ¨¡å¼ä¸ä½¿ç”¨åˆ†é 
                    setActiveCategory('waterfall');
                    setCurrentMode('quiz');
                    return;
                }

                // å°‡æ‰€æœ‰é¡Œç›®æ‰“äº‚
                let questions = [...allItems];
                questions.sort(() => Math.random() - 0.5);
                
                // ç‚ºäº†æ•ˆèƒ½ï¼Œå¦‚æœæ˜¯ç€‘å¸ƒæ¨¡å¼ï¼Œæˆ‘å€‘å¯ä»¥ä¸€æ¬¡åªè¼‰å…¥éƒ¨åˆ†ï¼Œä½†é€™è£¡ç‚ºäº†ç°¡å–®å…¨è¼‰å…¥ï¼ˆSPA è™•ç†å¹¾ç™¾é¡Œé‚„å¥½ï¼‰
                // ç”¢ç”Ÿé¸é …
                const quizSet = questions.map(item => { 
                    let pool = allItems.filter(i => i.id !== item.id); 
                    const distractors = pool.sort(() => Math.random() - 0.5).slice(0, 3); 
                    const options = [...distractors, item].sort(() => Math.random() - 0.5); 
                    return { ...item, options, userAnswer: null, isCorrect: null }; 
                });

                setQuizQuestions(quizSet);
                setQuizScore(0);
                setCombo(0);
                setQuizPage(0);
                setActiveCategory('waterfall');
                setCurrentMode('quiz');
                window.scrollTo(0,0);
            };

            const handleAnswer = (qIndex, selectedOptionId) => {
                const newQuestions = [...quizQuestions];
                const q = newQuestions[qIndex];
                if (q.userAnswer !== null) return; 
                
                const isCorrect = selectedOptionId === q.id;
                q.userAnswer = selectedOptionId;
                q.isCorrect = isCorrect;
                
                let newScore = quizScore;
                let newCombo = combo;

                if (isCorrect) {
                    newScore = quizScore + 1;
                    newCombo = combo + 1;
                    setQuizScore(newScore);
                    setCombo(newCombo);
                    playSoundEffect('correct');
                    
                    if (newCombo > 0 && newCombo % 5 === 0) {
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    } else {
                        confetti({ particleCount: 30, spread: 50, origin: { y: 0.7 }, scalar: 0.7 });
                    }
                } else {
                    newCombo = 0;
                    setCombo(0);
                    playSoundEffect('wrong');
                    const newMistakeLog = [...mistakeLog];
                    const existingIndex = newMistakeLog.findIndex(m => m.id === q.id);
                    if (existingIndex > -1) { 
                        newMistakeLog[existingIndex] = { ...newMistakeLog[existingIndex], count: newMistakeLog[existingIndex].count + 1, lastMissed: new Date().toISOString() }; 
                    } else { 
                        newMistakeLog.push({ id: q.id, count: 1, lastMissed: new Date().toISOString() }); 
                    }
                    setMistakeLog(newMistakeLog);
                    updateUserData('mistakes', newMistakeLog);
                }
                setQuizQuestions(newQuestions);
                
                // å„²å­˜é‚è¼¯åˆ†é›¢
                const sessionData = {
                    questions: newQuestions,
                    score: newScore,
                    combo: newCombo,
                    category: activeCategory,
                    pageIdx: quizPage,
                    timestamp: new Date().toISOString()
                };

                if (activeCategory === 'waterfall') {
                    updateUserData('currentWaterfallSession', sessionData);
                } else {
                    updateUserData('currentLevelSession', sessionData);
                }
            };

            const finishQuiz = () => {
                const record = { id: Date.now(), date: new Date().toLocaleString(), userName, score: quizScore, total: quizQuestions.length, category: activeCategory, details: quizQuestions.map(q => ({ term: q.term, definition: q.definition, sentence: q.sentence2, isCorrect: q.isCorrect, userAnswer: q.options.find(o => o.id === q.userAnswer)?.term || "æœªä½œç­”", correctAnswer: q.term })) };
                const newHistory = [record, ...historyLog]; setHistoryLog(newHistory); updateUserData('history', newHistory);
                
                if (activeCategory !== 'æ”¶è—å¤¾' && activeCategory !== 'éŒ¯é¡Œæœ¬' && activeCategory !== 'waterfall') { 
                    const key = `${activeCategory}-${quizPage}`; 
                    if (quizScore > 0) { 
                        const todayStr = new Date().toLocaleDateString();
                        const existingEntryIndex = completedDays.findIndex(item => item.id === key);
                        let newCompleted;
                        
                        if (existingEntryIndex >= 0) {
                            newCompleted = [...completedDays];
                            newCompleted[existingEntryIndex] = { ...newCompleted[existingEntryIndex], score: Math.max(newCompleted[existingEntryIndex].score || 0, quizScore), date: todayStr };
                        } else {
                            newCompleted = [...completedDays, { id: key, date: todayStr, score: quizScore }];
                        }
                        
                        setCompletedDays(newCompleted); 
                        updateUserData('progress', newCompleted); 
                    } 
                } 
                
                // æ¸…é™¤å°æ‡‰çš„æš«å­˜
                if (activeCategory === 'waterfall') {
                    updateUserData('currentWaterfallSession', null);
                    setSavedWaterfallSession(null);
                } else {
                    updateUserData('currentLevelSession', null);
                    setSavedLevelSession(null);
                }
            };

            return (
                <div className="min-h-screen font-sans selection:bg-amber-200 selection:text-amber-900 relative">
                    <div className="fixed inset-0 z-0 bg-cover bg-center transition-all duration-1000 no-print" style={{ backgroundImage: `url('${bgImage}')`, backgroundColor: '#fcf9f2' }}></div>
                    <div className="fixed inset-0 z-0 bg-white/70 backdrop-blur-[2px] no-print"></div>
                    <div className="relative z-10">
                        <MusicPlayer ref={musicPlayerRef} />
                        {currentMode === 'menu' && <MenuView userName={userName} setUserName={setUserName} showNameWarning={showNameWarning} mistakeLog={mistakeLog} favorites={favorites} parsedData={parsedData} onStartLearn={(cat) => { setActiveCategory(cat); setLearnPage(0); setCurrentMode('learn'); }} onStartQuiz={(cat, page = 0) => handleStartQuiz(cat, page)} onStartWaterfall={handleStartWaterfall} onViewHistory={() => setCurrentMode('history')} onViewMistakes={() => setCurrentMode('mistakes')} onViewTable={() => setCurrentMode('table')} onPrint={() => setCurrentMode('print')} onLogin={handleLogin} isLocked={isLocked} onQuickLogin={handleQuickLogin} lastUser={lastUser} onLogout={handleLogout} onDeleteUser={handleDeleteUser} globalUsers={globalUsers} triggerMusic={triggerMusic} connectionStatus={connectionStatus} completedDays={completedDays} />}
                        {currentMode === 'learn' && <LearnView items={activeCategory === 'æ”¶è—å¤¾' ? allItems.filter(i => favorites.includes(i.id)) : parsedData["ç²¾é¸æˆèª"]} learnPage={learnPage} setLearnPage={setLearnPage} favorites={favorites} toggleFavorite={toggleFavorite} completedDays={completedDays} onMenu={() => setCurrentMode('menu')} />}
                        {currentMode === 'quiz' && <QuizView questions={quizQuestions} score={quizScore} userName={userName} combo={combo} onAnswer={handleAnswer} onFinish={finishQuiz} onMenu={() => setCurrentMode('menu')} onViewHistory={() => setCurrentMode('history')} favorites={favorites} toggleFavorite={toggleFavorite} activeCategory={activeCategory} totalItems={activeCategory === 'æ”¶è—å¤¾' ? favorites.length : parsedData["ç²¾é¸æˆèª"].length} quizPage={quizPage} onPageChange={(page) => handleStartQuiz(activeCategory, page)} completedDays={completedDays} />}
                        {currentMode === 'history' && <HistoryView historyLog={historyLog} setHistoryLog={clearHistoryLog} onMenu={() => setCurrentMode('menu')} />}
                        {currentMode === 'mistakes' && <MistakeView mistakes={allItems.filter(i => mistakeLog.some(m => m.id === i.id))} mistakeLog={mistakeLog} setMistakeLog={clearMistakeLog} onMenu={() => setCurrentMode('menu')} onReviewAll={() => handleStartQuiz(null, 0, true)} />}
                        {currentMode === 'table' && <TableView items={allItems} onMenu={() => setCurrentMode('menu')} favorites={favorites} toggleFavorite={toggleFavorite} />}
                        {currentMode === 'print' && <PrintView items={allItems} onMenu={() => setCurrentMode('menu')} />}
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>